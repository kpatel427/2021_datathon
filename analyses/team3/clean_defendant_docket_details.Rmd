---
title: "Clean `defendant_docket_details.csv`"
author: "R-Ladies Philly Team 3"
date: "3/18/2021"
output:
  html_document:
    theme: lumen
    highlight: tango
    toc: yes
    toc_depth: 1
    toc_float: TRUE
---

```{r setup, include = FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(knitr)
library(kableExtra)

view_table <- function(tbl) {
  kable(tbl) %>%
    kable_styling(bootstrap_options = c("striped", "hover", "condensed", "responsive"), full_width = FALSE)
}
```

# Package dependencies

```{r dependencies, message = FALSE, warning = FALSE}
library(tidyverse)
library(janitor)
library(assertr)
library(lubridate)
library(glue)
library(rlang)
```

# Get data

```{r get_data}
ddt <- read_csv("https://storage.googleapis.com/jat-rladies-2021-datathon/defendant_docket_details.csv", col_types = cols(
  current_processing_status__processing_status = col_character())) %>%
  clean_names()

# Crosswalks allow us to collapse messy processing statuses
# Ask about where we should store files like this
processing_status_xwalk   <- read_csv(file.path("status_xwalk.csv"))
```

# Functions
```{r functions}
# flag_strings : search for values in a text column and create indicator var = 1 if found in column
# df = data frame
# search_val = value searching for in text column
# search_col = column to search for search_val
# new_name = name pattern of new indicator variable
flag_strings <- function(df, search_val, search_col, new_name) {
  colname <- glue("{new_name}_{tolower(search_val)}")
  mutate(df, !!colname := if_else(str_detect(UQ(sym(search_col)), search_val), 1, 0))
}

# uniq_strings : extract unique values from comma delimited string variables
uniq_strings <- function(df, extract_col) {
  df %>% pull(!!extract_col) %>%
    str_split(., ",") %>%
    unlist() %>%
    str_squish() %>%
    unique()
}

```

# Set expected data values

```{r expected_vals}
date_fmt                 <- "\\d{4}-\\d{2}-\\d{2}"
gender_cats              <- c("Female", "Male")
race_cats                <- c("Asian",
                              "Asian/Pacific Islander",
                              "Bi-Racial",
                              "Black",
                              "Native American/Alaskan Native",
                              "Unknown/Unreported",
                              "White")
status_cats              <- c("Active", "Adjudicated", "Closed", "Inactive")
court_cats               <- c("Municipal Court - Philadelphia County",
                              "Philadelphia County Court of Common Pleas")
court_abbrev_cats        <- c("CP", "CP, MC", "MC", "MC, CP")
processing_status_cats   <- unique(processing_status_xwalk$orig_processing_status)
municipality_cats        <- c("Bensalem Township",
                              "E Goshen Township",
                              "Philadelphia City",
                              "Upper Darby Township",
                              "Warminster Township" )
county_cats              <- c("Bucks", "Chester", "Delaware", "Philadelphia")

earliest_dob <- ymd("1905-01-01")

```

# Check input data

```{r check_inputs}
ddt %>%
  verify(is_uniq(docket_id)) %>%
  verify(gender %in% gender_cats | is.na(gender)) %>%
  verify(race %in% race_cats | is.na(race)) %>%
  verify(str_detect(date_of_birth, date_fmt) | is.na(date_of_birth)) %>%
  verify(str_detect(arrest_date, date_fmt) | is.na(arrest_date)) %>%
  verify(str_detect(complaint_date, date_fmt) | is.na(complaint_date)) %>%
  verify(str_detect(disposition_date, date_fmt) | is.na(disposition_date)) %>%
  verify(str_detect(filing_date, date_fmt) | is.na(filing_date)) %>%
  verify(str_detect(initiation_date, date_fmt) | is.na(initiation_date)) %>%
  verify(status_name %in% status_cats) %>%
  verify(court_office_court_display_name %in% court_cats) %>%
  verify(current_processing_status_processing_status %in% processing_status_cats | is.na(current_processing_status_processing_status)) %>%
  verify(str_detect(current_processing_status_status_change_datetime, date_fmt)) %>%
  verify(municipality_name %in% municipality_cats | is.na(municipality_name)) %>%
  verify(municipality_county_name %in% county_cats | is.na(municipality_county_name)) %>%
  verify(str_detect(judicial_districts, "Philadelphia")) %>%
  invisible()
```


# Clean data

## TO DO

- Should we drop municipality name outside of Philadelphia?
- Not sure what we expect RE: ranges of date values. Produce report?
- Check crosswalks: status_xwalk, representation_type_xwalk
- Variable order
- Is it meaningful to have sum of representation type?
- Meaning of court_office_types vs. court_types?
- Do we need codebook, esp. for newly created variables?
- Create clean data file specs

```{r clean_data}
# race
ddt <- ddt %>%
  mutate(race = case_when(race == "Asian" ~ "Asian/Pacific Islander",
                          is.na(race)     ~ "Unknown/Unreported",
                          TRUE            ~ race))
# dob
ggplot(ddt %>% filter(date_of_birth < dmy("1-1-1950")),
       aes(x = date_of_birth)) +
  labs(title = "Obs. with unlikely DOBs",
       subtitle = "See 1900") +
  geom_density()

ddt <- ddt %>% mutate(date_of_birth = if_else(date_of_birth < earliest_dob, NA_Date_, date_of_birth))

# cleaned processing status
before_merg <- nrow(ddt)
ddt <- left_join(ddt, processing_status_xwalk,
                 by = c("current_processing_status_processing_status" = "orig_processing_status"))
# just check that rows weren't added -- we already checked for missing categories in xwalk in input data checks
stopifnot(before_merg == nrow(ddt))

ddt <- ddt %>%
  select(-current_processing_status_processing_status) %>%
  rename(processing_status = clean_processing_status)

# create indicator variables for court_office_types
uniq_court_office_types <- uniq_strings(ddt, "court_office_types")

for (c in uniq_court_office_types) {
  ddt <- flag_strings(ddt, c, "court_office_types", "court")
}

# create indicator variables for court_types
uniq_court_types <- uniq_strings(ddt, "court_types")

for (c in uniq_court_types) {
  ddt <- flag_strings(ddt, c, "court_types", "ofc")
}

# clean representation type
uniq_representation_type <- uniq_strings(ddt, "representation_type")
uniq_representation_type
# drop hyphenated descriptor after type
# doing manual way for now ...
descriptors <- c("Court Appointed",
                 "Public Defender",
                 "Vendor",
                 "Private",
                 "Co-Counsel",
                 "Pending")
for (d in descriptors) {
  ddt <- ddt %>% mutate_at(vars(representation_type), ~(str_replace_all(., glue(" - {d}"), "")))
  
}

uniq_representation_type <- uniq_strings(ddt, "representation_type")

for (r in uniq_representation_type) {
  ddt <- flag_strings(ddt, r, "representation_type", "rep")
}

```

# Export

```{r export}
# Export data somewhere
```
