---
title: "Clean `defendant_docket_details.csv`"
author: "R-Ladies Philly Team 3"
date: "3/18/2021"
output:
  html_document:
    theme: lumen
    highlight: tango
    toc: yes
    toc_depth: 3
    toc_float: TRUE
---

```{r setup, include = FALSE}
knitr::opts_chunk$set(echo = TRUE, message = FALSE, warning = FALSE)
```

# Package dependencies

```{r dependencies}
library(knitr)
library(kableExtra)
library(tidyverse)
library(janitor)
library(assertr)
library(lubridate)
library(glue)
library(rlang)
```

# Get data

```{r get_data}
# ddt <- read_csv("https://storage.googleapis.com/jat-rladies-2021-datathon/defendant_docket_details.csv", col_types = cols(
#   current_processing_status__processing_status = col_character())) %>%
#   clean_names()
ddt <- read_csv("c:/users/aplar/downloads/origddt.csv", col_types = cols(
  current_processing_status_processing_status = col_character())) %>%
  clean_names()

# Crosswalks allow us to collapse messy processing statuses
# Ask about where we should store files like this
processing_status_xwalk   <- read_csv(file.path("status_xwalk.csv"))
```

# Functions
```{r functions}
# uniq_strings : extract unique values from comma delimited string variables
uniq_strings <- function(df, extract_col) {
  s <- df %>% pull(!!extract_col) %>%
    str_split(., ",") %>%
    unlist() %>%
    str_squish() %>%
    unique() %>%
    sort(decreasing = TRUE)
  s <- s[!is.na(s)]
  return(s)
}

# flag_strings : search for values in a text column and create indicator var = 1 if found in column
# df = data frame
# search_val = value searching for in text column
# search_col = column to search for search_val
# new_name = name pattern of new indicator variable
flag_strings <- function(df, search_val, search_col, new_name) {
  colname <- tolower(search_val) %>%
    str_replace_all(., " |/|-", "_") %>%
    str_replace_all(., "'", "")
  colname <- glue("{new_name}_{colname}")
  df <- df %>%
    mutate(!!colname := if_else(str_detect(UQ(sym(search_col)), search_val), 1, 0)) %>%
    relocate(UQ(sym(colname)), .after = UQ(sym(search_col)))
}

view_table <- function(tbl) {
  kable(tbl) %>%
    kable_styling(bootstrap_options = c("striped", "hover", "condensed", "responsive"), full_width = FALSE) %>%
    print()
}

make_table <- function(var) {
  t <- tabyl(ddt, var) %>%
    select(1:3) %>%
    mutate(percent = round(percent * 100, 3))
  names(t) <- c(var, "n", "percent")
  return(t)
}
```

# Set expected data values

```{r expected_vals}
date_fmt                 <- "\\d{4}-\\d{2}-\\d{2}"
gender_cats              <- c("Female", "Male")
race_cats                <- c("Asian",
                              "Asian/Pacific Islander",
                              "Bi-Racial",
                              "Black",
                              "Native American/Alaskan Native",
                              "Unknown/Unreported",
                              "White")
status_cats              <- c("Active", "Adjudicated", "Closed", "Inactive")
court_cats               <- c("Municipal Court - Philadelphia County",
                              "Philadelphia County Court of Common Pleas")
court_abbrev_cats        <- c("CP", "CP, MC", "MC", "MC, CP")
processing_status_cats   <- unique(processing_status_xwalk$orig_processing_status)
municipality_cats        <- c("Bensalem Township",
                              "E Goshen Township",
                              "Philadelphia City",
                              "Upper Darby Township",
                              "Warminster Township" )
county_cats              <- c("Bucks", "Chester", "Delaware", "Philadelphia")

earliest_date <- ymd("1905-01-01")
krasner_start <- ymd("2018-01-01")

```

# Check input data

```{r check_inputs}
ddt %>%
  verify(is_uniq(docket_id)) %>%
  verify(gender %in% gender_cats | is.na(gender)) %>%
  verify(race %in% race_cats | is.na(race)) %>%
  verify(str_detect(date_of_birth, date_fmt) | is.na(date_of_birth)) %>%
  verify(str_detect(arrest_date, date_fmt) | is.na(arrest_date)) %>%
  verify(str_detect(complaint_date, date_fmt) | is.na(complaint_date)) %>%
  verify(str_detect(disposition_date, date_fmt) | is.na(disposition_date)) %>%
  verify(str_detect(filing_date, date_fmt) | is.na(filing_date)) %>%
  verify(str_detect(initiation_date, date_fmt) | is.na(initiation_date)) %>%
  verify(status_name %in% status_cats) %>%
  verify(court_office_court_display_name %in% court_cats) %>%
  verify(current_processing_status_processing_status %in% processing_status_cats | is.na(current_processing_status_processing_status)) %>%
  verify(str_detect(current_processing_status_status_change_datetime, date_fmt)) %>%
  verify(municipality_name %in% municipality_cats | is.na(municipality_name)) %>%
  verify(municipality_county_name %in% county_cats | is.na(municipality_county_name)) %>%
  verify(str_detect(judicial_districts, "Philadelphia")) %>%
  invisible()
```


# Clean data

## Clean existing variables

```{r clean_existing}
# race
ddt <- ddt %>%
  mutate(race = case_when(race == "Asian" ~ "Asian/Pacific Islander",
                          is.na(race)     ~ "Unknown/Unreported",
                          TRUE            ~ race))
# dob
# Set dobs before 1906 to NA
ddt <- ddt %>% mutate(date_of_birth = if_else(date_of_birth <= earliest_date, NA_Date_, date_of_birth))

# merged on cleaned processing status
before_merg <- nrow(ddt)
ddt <- left_join(ddt, processing_status_xwalk,
                 by = c("current_processing_status_processing_status" = "orig_processing_status"))
# just check that rows weren't added in merge -- we already checked for missing categories in xwalk in input data checks
stopifnot(before_merg == nrow(ddt))

ddt <- ddt %>%
  select(-current_processing_status_processing_status) %>%
  rename(current_processing_status = clean_processing_status) %>%
  relocate(current_processing_status, .before = current_processing_status_status_change_datetime)

# current_processing_status_status_change_datetime
ddt <- ddt %>%
  mutate(current_processing_status_status_change_datetime = if_else(current_processing_status_status_change_datetime <= earliest_date,
                                                                    NA_Date_,
                                                                    current_processing_status_status_change_datetime))

# representation type
uniq_representation_type <- uniq_strings(ddt, "representation_type")
uniq_representation_type
# drop hyphenated descriptor after type
# doing manual way for now ...
descriptors <- c("Court Appointed",
                 "Public Defender",
                 "Vendor",
                 "Private",
                 "Co-Counsel",
                 "Pending")
for (d in descriptors) {
  ddt <- ddt %>% mutate_at(vars(representation_type), ~(str_replace_all(., glue(" - {d}"), "")))
  
}
```

## Constructed variables

```{r constructs}
# indicator variables for judicial_districts
uniq_judicial_districts <- uniq_strings(ddt, "judicial_districts")

for (j in uniq_judicial_districts) {
  ddt <- flag_strings(ddt, j, "judicial_districts", "jd")
}
ddt <- ddt %>%
  rowwise() %>%
  mutate(judicial_districts_count := sum(c_across(jd_adams:jd_york))) %>%
  ungroup() %>%
  relocate(judicial_districts_count, .after = judicial_districts)

# indicator variables for court_office_types
uniq_court_office_types <- uniq_strings(ddt, "court_office_types")

for (c in uniq_court_office_types) {
  ddt <- flag_strings(ddt, c, "court_office_types", "court_ofc")
}
ddt <- ddt %>%
  rowwise() %>%
  mutate(court_office_types_count := sum(c_across(court_ofc_commonwealth:court_ofc_supreme))) %>%
  ungroup() %>%
  relocate(court_office_types_count, .after = court_office_types)

# indicator variables for court_types
uniq_court_types <- uniq_strings(ddt, "court_types")

for (c in uniq_court_types) {
  ddt <- flag_strings(ddt, c, "court_types", "court")
}
ddt <- ddt %>%
  rowwise() %>%
  mutate(court_types_count := sum(c_across(court_cp:court_pac))) %>%
  ungroup() %>%
  relocate(court_types_count, .after = court_types)

# indicator variables for representation type
uniq_representation_type <- uniq_strings(ddt, "representation_type")

for (r in uniq_representation_type) {
  ddt <- flag_strings(ddt, r, "representation_type", "rep")
}
ddt <- ddt %>%
  rowwise() %>%
  mutate(representation_type_count := sum(c_across(rep_attorney_general:rep_standby))) %>%
  ungroup() %>%
  relocate(representation_type_count, .after = representation_type)

# krasner
# disposition_date arbitrarily chosen here...
ddt <- ddt %>%
  mutate(krasner = if_else(disposition_date < krasner_start, 0, 1),
         krasner_years = as.numeric(interval(krasner_start, disposition_date), "years"))

```

# Data checks

## Date variables
```{r check_date}
date_cols <- names(ddt)[which(str_detect(names(ddt), "date"))]

ddt %>%
  select(!!!date_cols) %>%
  summary()
```

## Discrete variables
```{r check_discrete, results = "asis"}
discrete_cols <- names(ddt)[sapply(ddt, function(var) length(unique(var)) <= 100)] %>%
  setdiff(., date_cols)

for (d in discrete_cols) {
  make_table(d) %>%
    view_table()
}

```

## Continuous variables
```{r check_continuous}
continuous_cols <- setdiff(names(ddt), discrete_cols) %>%
  setdiff(., date_cols)

ddt %>%
  select(!!!continuous_cols) %>%
  summary()
```

## Order of variables on file
```{r order}
glimpse(ddt)
```

# Data questions

- Should we drop municipality name outside of Philadelphia?
- Check crosswalks: status_xwalk
- Meaning of court_office_types vs. court_types?
- Do we need codebook, esp. for newly created variables?

# Export

```{r export, eval = FALSE}
# Export data somewhere
```
